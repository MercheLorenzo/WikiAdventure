<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Wiki Adventure chat Room $1</title>
    <link id="uiCSS" rel="stylesheet" href="/css/chatSection.css">
  </head>
  <body id="mwAA" lang="en" class="mw-content-ltr sitedir-ltr ltr mw-body-content parsoid-body mediawiki mw-parser-output" dir="ltr">
    <section id="wikiSection">

    </section>
    <input id="showUI" type="checkbox"/>
      <section id="uiSection" type="checkbox">
        <label for="showUI" id="labelShowUI">&#9658;</label>
        <div id="actionSection">
          <div><p id="stateName"></p><p id="stateTime"></p></div>
          <div id="vote"><p>Your vote :</p><p id="playerVote"></p></div>
          <form action="" id="votingForm" class="uiForm">
            <input id="inputVote" class="uiInput" placeholder="Send your wiki page title suggestion" autocomplete="off" /><button class="uiSubmit" id="voteSubmit">&#10004;</button>
          </form>
          <div><p>Start page :</p><p id="pageStart"></p></div>
          <div><p>End page :</p><p id="pageEnd"></p></div>
        </div>
        <div id="chatSection">
          <ul id="outputMessages"></ul>
          <form action="" id="chatForm" class="uiForm">
            <input id="inputMessage" class="uiInput" placeholder="Send a message to the lobby" autocomplete="off" /><button class="uiSubmit" id="send">&#10004;</button>
          </form>
        </div>
      </section>
    
    <script id="ioImport" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>

    <script id="mainScript">
        var lobbyID = "$1";
        var hasVoted = false;
        var playerID = "$2";
        var socket;
        var pageStart;
        var pageEnd;
        if (history.pushState) {
            window.history.pushState("lobby $1", "WikiAdventure", "play/$1");
        } else {
            document.location.href = "play/$1";
        }
        var url = window.location.href;
        var idx = url.indexOf("play/");
        var id =  url.substring(idx+5);
        addEventListener("load",(function () {
            socket = io("/"+id,  { query: "playerID="+playerID });
            socket.on('error', (error) => {
              console.log(error);
              console.log("Please make sure you are not modifying your modyfing anything, if not report the issue");
              addMessage(error);
              addMessage("Please make sure you are not modifying your modyfing anything, if not report the issue");
            });
            document.getElementById('chatForm').onsubmit = function(e){
                e.preventDefault(); // prevents page reloading
                socket.emit('message', document.getElementById('inputMessage').value);
                document.getElementById('inputMessage').value = "";
                var hasVoted = true;
                return false;
            };
            document.getElementById('votingForm').onsubmit = function(e){
                e.preventDefault(); // prevents page reloading
                socket.emit('vote', document.getElementById('inputVote').value);
                document.getElementById("playerVote").innerText = document.getElementById('inputVote').value;
                document.getElementById('inputVote').value = "";
                document.getElementById('inputVote').placeholder = "Your suggestion will override the previous one";
                return false;
            };
            socket.on('message', function(msg){
                addMessage(msg);
            });
            socket.on('voteResult', function(data){
                var idx = data.indexOf("?");
                pageStart = data.substring(0, idx);
                document.getElementById("pageStart").innerText = pageStart;
                pageEnd = data.substring(idx+1);
                document.getElementById("pageEnd").innerText = pageEnd;
                requestWikiPage(pageStart);
            });
            socket.on('gameContent', function(data){
                var idx = data.indexOf(":");
                var type = data.substring(0, idx);
                var content = data.substring(idx+1);

                switch (type) {
                  case "gameState":
                      switchState(content);
                  case "votingResult":

                }
            });
        }));

        var switchState = function (data) {
            var hasVoted = false;
            document.getElementById('inputVote').placeholder = "Send your wiki page title suggestion";
            var idx = data.indexOf("|");
            var state = data.substring(0, idx);
            var time = data.substring(idx+1);
            document.getElementById("stateName").innerText = state;
            var timeLeft = time;
            var timeStamp = Date.now();
            var stateCounter = setInterval(function() {
                var time = Date.now();
                var dt = time - timeStamp;
                timeStamp = time;
                timeLeft = timeLeft - dt*0.001;
                document.getElementById("stateTime").innerText = Math.ceil(timeLeft);
                if (timeLeft < 0) {
                  clearInterval(stateCounter);
                  document.getElementById("stateTime").innerText = 0;
                }
            }, 100);
        };

        var addMessage = function (message) {
            var messageLine = document.createElement('li');
            messageLine.textContent = message;
            document.getElementById('outputMessages').insertBefore(messageLine, document.getElementById('outputMessages').childNodes[0]);
        };
        
    addEventListener("beforeunload", function (event) {
        var confirmationMessage = "Are you sure you want to exit? you will lose your session.";
        event.returnValue = confirmationMessage;
        return confirmationMessage;
    });

    //Code to toggle of the link of the wikipedia page and redirect them to custom function

    var disableLinks = function () {
      var links= document.getElementsByTagName("a");
        for (var i=0;i<links.length;i++) {
            links[i].addEventListener("click",function(e){
              //check if the link go to another wikipage and not info page or external

              if (this.getAttribute("href").lastIndexOf(":") == -1 && this.getAttribute("href").lastIndexOf(".ogg") == -1 && this.rel != "mw:ExtLink" && !this.classList.contains("new")) {
                var idx = this.href.lastIndexOf("/");
                var url = this.href.substring(idx+1);
                requestWikiPage(url);

              }
              e.preventDefault();
            });
        }
    };

    var requestWikiPage = function(url) {
      var requestWiki = new XMLHttpRequest();
        requestWiki.open("get","https://en.wikipedia.org/api/rest_v1/page/html/" + url);
        requestWiki.send();
        requestWiki.onloadend = function () {
          var parser = new DOMParser();
          var wikiData = parser.parseFromString(requestWiki.response, "text/html") ;
          var cssLinks = wikiData.head.getElementsByTagName("link");
          var content = wikiData.body.childNodes;
          document.getElementById("wikiSection").innerHTML = "";

          for (var i=0;i<document.head.childNodes.length;i++) {
            if (document.head.childNodes[i].tagName == "link" && document.head.childNodes[i].id != "uiCSS") {
              document.head.childNodes[i].remove();
            }
          }
          for (var i=0;i<cssLinks.length;i++) {
            if (cssLinks[i].rel == "stylesheet") {
              cssLinks[i].href += "https://en.wikipedia.org";
              document.head.appendChild(cssLinks[i]);
            }
          }

          for (var i = 0; i < content.length; i++) {
            document.getElementById("wikiSection").appendChild(content[i]);
          }
          
          disableLinks();
          document.body.scrollTop = 0; // For Safari
          document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
          if (history.pushState) {
            window.history.pushState("lobby $1", "WikiAdventure", url);
          } else {
            document.location.href = url;
          }
        };
    };

    </script>
  </body>
</html>