name: Compile and deploy to heroku

on:
  workflow_dispatch:
    
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
      - name: Setup Haxe environment
        # You may pin to the exact commit or the version.
        # uses: krdlab/setup-haxe@aab4595a86d3a14ec1b51b9dabad6b6e7810313e
        uses: krdlab/setup-haxe@v1.1.4
        with:
          # Version Spec of the version to use. Example: 3.4.7
          haxe-version: 4.1.4
      - name: Install backend lib
        run: |
          haxelib install node.hxml --always
      - name: Compile backend
        run: |
          haxe node.hxml
      - name: Install frontend lib
        run: |
          cd front-quasar/wiki-adventure-quasar; npm i; quasar build
      - name: Deploy to heroku
        uses: Sacramentix/heroku-deploy@30f0b7e30306900d74c1d7fd5414e1f8421652ba
        with:
          heroku_api_key: ${{secrets.HEROKU_API_KEY}}
          heroku_app_name: "wiki-adventure-io"
          heroku_email: ${{secrets.HEROKU_EMAIL}}
          appdir: "bin"
        env:
          HD_TWITCH_BOT_USERNAME: ${{secrets.TWITCH_BOT_USERNAME}}
          HD_TWITCH_BOT_PASSWORD: ${{secrets.TWITCH_BOT_PASSWORD}}
          HD_TWITCH_CLIENT_ID: ${{secrets.TWITCH_CLIENT_ID}}
          HD_TWITCH_CLIENT_SECRET: ${{secrets.TWITCH_CLIENT_SECRET}}
          HD_TWITCH_REDIRECT_URL: ${{secrets.TWITCH_REDIRECT_URL}}
